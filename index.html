<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ISACA Club Email Verification</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background-color: #e5f3fd;
      text-align: center;
    }
    img.logo {
      max-width: 200px;
      margin-bottom: 20px;
    }
    h2 {
      margin-bottom: 20px;
    }
    input {
      padding: 8px;
      font-size: 16px;
      margin-right: 10px;
      width: 120px;
    }
    button {
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #message {
      color: red;
      margin-top: 10px;
    }
    #redirectMsg {
      margin-top: 20px;
      color: green;
      font-weight: bold;
    }
    a {
      color: #0066cc;
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <img src="https://i.imgur.com/cCXGlAR.png" alt="ISACA Club Logo" class="logo" />
  <h2>ISACA Cybersecurity Club Verification</h2>
  <p>Enter your 6-digit verification code:</p>

  <div id="inputSection">
    <input type="text" id="code" maxlength="6" placeholder="Enter code" />
    <button id="verifyBtn" onclick="verifyCode()">Verify</button>
  </div>

  <p id="message"></p>
  <p id="redirectMsg"></p>

  <script>
    const apiEndpoint = "https://script.google.com/macros/s/AKfycbxeAJ7_w_RXUDkk8L01TbP4dQKp0OLUH-sibLJGT4walg_RyMiSXTDv7mGJ6gK556QKFA/exec";

    function verifyCode() {
      const code = document.getElementById("code").value.trim();
      const msg = document.getElementById("message");
      const redirectMsg = document.getElementById("redirectMsg");
      const verifyBtn = document.getElementById("verifyBtn");
      
      msg.innerText = "";
      redirectMsg.innerHTML = "";

      if (code.length !== 6) {
        msg.innerText = "Please enter a 6-digit code.";
        return;
      }

      // Disable button during verification
      verifyBtn.disabled = true;
      verifyBtn.innerText = "Verifying...";

      // Remove old script if exists
      const oldScript = document.getElementById("jsonpScript");
      if (oldScript) oldScript.remove();

      // Create JSONP request
      const script = document.createElement("script");
      script.id = "jsonpScript";
      script.src = `${apiEndpoint}?code=${encodeURIComponent(code)}&callback=handleVerification`;
      
      // Handle script load errors
      script.onerror = function() {
        msg.innerText = "Failed to connect to verification server. Please try again.";
        verifyBtn.disabled = false;
        verifyBtn.innerText = "Verify";
      };
      
      document.body.appendChild(script);
    }

    function handleVerification(result) {
      const msg = document.getElementById("message");
      const redirectMsg = document.getElementById("redirectMsg");
      const verifyBtn = document.getElementById("verifyBtn");

      // Re-enable button
      verifyBtn.disabled = false;
      verifyBtn.innerText = "Verify";

      if (result.status === "verified" && result.token) {
        document.getElementById("inputSection").style.display = "none";
        redirectMsg.innerHTML = "✅ Code verified! Retrieving link...";
        
        // Now fetch the actual WhatsApp link using the token
        fetchWhatsAppLink(result.token);
        
      } else if (result.status === "used") {
        msg.innerText = "❌ This code has already been used.";
      } else if (result.status === "invalid") {
        msg.innerText = "❌ Invalid code. Please check your email.";
      } else if (result.status === "error") {
        msg.innerText = "❌ Error: " + result.message;
      } else {
        msg.innerText = "❌ Unexpected response. Please try again later.";
      }
    }

    function fetchWhatsAppLink(token) {
      const msg = document.getElementById("message");
      const redirectMsg = document.getElementById("redirectMsg");

      // Remove old script if exists
      const oldScript = document.getElementById("jsonpScript2");
      if (oldScript) oldScript.remove();

      // Create JSONP request for the link
      const script = document.createElement("script");
      script.id = "jsonpScript2";
      script.src = `${apiEndpoint}?token=${encodeURIComponent(token)}&callback=handleLink`;
      
      script.onerror = function() {
        msg.innerText = "Failed to retrieve link. Please try again.";
      };
      
      document.body.appendChild(script);
    }

    function handleLink(result) {
      const msg = document.getElementById("message");
      const redirectMsg = document.getElementById("redirectMsg");

      if (result.status === "success" && result.link) {
        redirectMsg.innerHTML = "✅ Opening WhatsApp...";
        
        // Open WhatsApp in new tab
        const newWindow = window.open(result.link, "_blank");
        
        // Check if popup was blocked
        if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
          redirectMsg.innerHTML = "✅ Verified! Please allow popups or <a onclick='retryOpen(\"" + result.link + "\")'>click here</a> to open WhatsApp.";
        } else {
          redirectMsg.innerHTML = "✅ Success! WhatsApp group opened in new tab.";
        }
      } else if (result.status === "expired") {
        msg.innerText = "❌ Link expired. Please verify again.";
        document.getElementById("inputSection").style.display = "block";
      } else {
        msg.innerText = "❌ Failed to retrieve link. Please try again.";
      }
    }

    function retryOpen(link) {
      window.open(link, "_blank");
      return false;
    }

    // Allow Enter key to submit
    document.getElementById("code").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        verifyCode();
      }
    });
  </script>
</body>
</html>
